# 骨アニメーション FBX ビューワ実装計画・仕様まとめ

## 目的
- **メッシュを含まない FBX（ジョイント／ボーン階層 + アニメーション）の再生と可視化** をブラウザだけで行う。  
- 依存ライブラリは Three.js のみとし、**単一 HTML ファイルで完結**させる。  
- 軽量でスマホでも動作し、ドラッグ操作で視点を確認できることを目標とする。

---

## 採用技術
| 項目                 | 採用ライブラリ / API | 理由 |
|----------------------|----------------------|------|
| 3D レンダリング      | `three.js`           | WebGL 抽象化の事実上標準。ドキュメント・サンプルが豊富。 |
| FBX ローダ           | `FBXLoader`          | Three.js 公式例。Blender 由来のアニメーション付き FBX も読める。 |
| 骨可視化             | `SkeletonHelper`     | SkinnedMesh が無くても Bone 階層を線分で描画できる。 |
| カメラ操作           | `OrbitControls`      | マウス／タッチで回転・パン・ズームを実装。 |
| アニメーション再生   | `AnimationMixer`     | FBX 内の `AnimationClip` をそのまま再生可能。 |


## 使い方

### 基本的な手順
1. **完成版ファイル**: `fbx_joint_fixed.html` を使用
2. 同じ場所に `your_skeleton.fbx` を配置
3. HTTPサーバを起動してブラウザでアクセス

**HTTPサーバの起動**:
```bash
# Python 3の場合
python -m http.server 8000

# Node.jsの場合
npx serve .
```

**アクセスURL**: http://localhost:8000/fbx_joint_fixed.html

### 完成版の主要機能

#### スケール・表示機能
- **1000mグリッド表示**: 10m間隔の実用的なスケール（建築・キャラクター対応）
- **座標系自動修正**: Z-upからY-upへの座標変換で正しい向きに表示
- **適切なカメラ設定**: 1-10000の遠近クリップ範囲で大規模シーンに対応
- **詳細なデバッグログ**: コンソールで読み込み状況を確認可能
- **エラーハンドリング**: ファイルが見つからない場合に画面上にエラー表示
- **改良されたスケルトン検出**: SkinnedMeshとボーン階層の両方に対応
- **代替表示**: スケルトンが見つからない場合はAxesHelperでボーンを可視化

#### アニメーション制御UI
- **統合再生/停止ボタン**: ワンクリックで再生⇔停止を切り替え
  - 再生中: 「⏸ 停止」（オレンジ色）
  - 停止中: 「▶ 再生」（緑色）
- **リセットボタン**: 「⏮ リセット」でアニメーションを最初から再生
- **精密タイムスライダー**: 600px幅の長いスライダーで任意時間にジャンプ
- **速度調整**: 0.1倍〜3.0倍の再生速度変更
- **リアルタイム時間表示**: 現在時間/総時間を秒単位で表示
- **中央配置UI**: 画面下部中央の使いやすいレイアウト

#### 操作方法
- **視点操作**: マウスドラッグで回転、ホイールでズーム、右クリックドラッグでパン
- **アニメーション制御**: 画面下部のコントロールパネルで操作
- **デバッグ確認**: ブラウザの開発者ツール（F12）で詳細情報を確認

### デバッグ方法
1. ブラウザの開発者ツール（F12）を開く
2. Consoleタブで以下の情報を確認：
   - FBXファイルの読み込み状況
   - 検出されたオブジェクトとボーンの情報
   - アニメーションの有無とその詳細
   - カメラ位置とオブジェクトサイズ
   - エラーメッセージ

### 実装完了済み機能チェックリスト
#### ファイル準備・読み込み
- [x] 骨付きFBXファイル対応（Blenderでの「Bake Animation」推奨）
- [x] Three.js v0.163.0使用（最新安定版）
- [x] importmap方式によるモダンなモジュール管理
- [x] 詳細なエラーハンドリングとデバッグログ

#### 表示・レンダリング機能
- [x] 1000m x 1000mグリッド表示（10m間隔）
- [x] Z-up → Y-up座標系自動変換
- [x] 1-10000の適切なカメラクリップ範囲
- [x] SkinnedMeshとボーン階層の両方に対応したスケルトン検出
- [x] 代替AxesHelperによるボーン可視化
- [x] オブジェクトサイズに基づく自動カメラ位置調整

#### アニメーション制御UI
- [x] 統合再生/停止ボタン（状態表示付き）
- [x] リセット機能
- [x] 600px幅の精密タイムスライダー
- [x] 0.1-3.0倍速度調整
- [x] リアルタイム時間表示
- [x] 中央配置レスポンシブUI

#### 操作性・ユーザビリティ
- [x] OrbitControlsによる直感的な視点操作
- [x] マウス/タッチ対応
- [x] リサイズ対応
- [x] モバイルデバイス対応

### トラブルシューティング
#### よくある問題と対策
- **FBXが読み込めない** → ファイルパスと同一フォルダ配置を確認
- **アニメーションが再生されない** → `root.animations.length が 0`の場合、FBX内にアニメーションクリップが無い
- **スケルトンが表示されない** → 代替でAxesHelperが自動表示される
- **向きがおかしい** → Z-up/Y-up変換が自動適用されるが、必要に応じて手動調整可能
- **スケールが合わない** → 1000mグリッドを基準に、FBXファイルのスケール確認
- **ブラウザがローカル読み込み拒否** → HTTPサーバ起動が必須

発展

複数クリップ切替 UI：AnimationClip.findByName + <select>

骨軸の可視化：各 Bone に AxesHelper を配置

glTF 形式への移行：FBXLoader → GLTFLoader に差し替え

主要クラス／メソッド
クラス / 関数	用途	重要プロパティ
THREE.FBXLoader	FBX 読み込み	.load(url, onLoad)
THREE.SkeletonHelper	Bone 可視化	コンストラクタにルート Bone を渡す
THREE.AnimationMixer	クリップ再生制御	.clipAction(clip).play()
THREE.OrbitControls	カメラ操作	マウス/タッチ入力を自動処理

トラブルシューティング早見表
症状	主な原因 & 対策
骨が表示されない	Bone が Object3D のまま。isBone 判定や SkeletonHelper の引数を確認
アニメーションが動かない	root.animations が空。FBX 再書き出し時に「アニメーションをベイク」する
モデルが寝ている／上下反転	FBX の Z-up → Y-up 変換不足。root.rotation.set(-Math.PI/2,0,0) などで補正
ブラウザがローカル読み込み拒否	CORS 制限。python -m http.server などで簡易 HTTP サーバを立てる

代替ワークフロー
ワークフロー	概要	利点
FBX → glTF 変換	fbx2gltf CLI または Blender Export	Three.js 推奨形式、ファイルサイズ削減
FBX → BVH 変換	モーションだけ必要な場合	Three.js BVHLoader の公式サンプルを流用可
外部ビューワ埋め込み	Don McCurdy 氏の glTF Viewer などを <iframe> で埋め込む	実装コスト最小、ただし変換が前提

今後の拡張アイデア
GUI：dat.GUI / lil-gui でアニメーション速度・停止などを調整

Web Components 化：Viewer をカスタム要素 <skeleton-viewer> として切り出し、再利用性向上

ドラッグ＆ドロップ読込：<input type="file"> で任意の FBX をそのまま表示

モバイル最適化：デバイスピクセル比に応じて renderer.setPixelRatio を調整